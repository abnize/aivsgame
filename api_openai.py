import os
import json
import re
import random
from openai import OpenAI
from memory_manager import load_memory, random_memory_snippet

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ------------------------------------------------------------
# ğŸŒˆ ë ˆë²¨ â†’ ë‚œì´ë„ ë§¤í•‘
# ------------------------------------------------------------
def _topic(level):
    if level <= 2: return "ì´ˆë“±ìˆ˜ì¤€ ê³„ì‚°Â·ê¸°ì´ˆ ìƒì‹"
    elif level == 3: return "ìœ ëª… í•œêµ­ì–´ ë„Œì„¼ìŠ¤ í€´ì¦ˆ(ì¸í„°ë„·ì—ì„œ ë§ì´ ì•Œë ¤ì§„ ê²ƒë§Œ)"
    elif level == 4: return "í•œêµ­ ê¸°ì´ˆìƒì‹Â·ìƒí™œ ìƒì‹"
    elif level == 5: return "ì¤‘í•™êµ ìˆ˜ì¤€ ì—­ì‚¬Â·ê³¼í•™Â·ì§€ë¦¬"
    elif level == 6: return "ì†ë‹´Â·ë¬¸í™”Â·ìŒì‹ ìƒì‹"
    elif level == 7: return "ê³ ë“±í•™êµ ìˆ˜í•™Â·ë¬¼ë¦¬Â·êµ­ì‚¬"
    elif level == 8: return "ì‹¬í™” ìƒì‹Â·ì¶”ë¦¬"
    elif level == 9: return "í•œêµ­ ìœ ë¨¸Â·ê¸°ë°œí•œ ë¬¸ì œ"
    else: return "ëŒ€í•™ êµì–‘Â·ì „ë¬¸ì  ì‚¬ê³  ë¬¸ì œ"

# ------------------------------------------------------------
# ğŸ”° ìœ ëª… ë„Œì„¼ìŠ¤ ë¬¸ì œ (ë ˆë²¨ 3ì—ì„œë§Œ ì‚¬ìš©)
# ------------------------------------------------------------
NONSENSE_BANK = [
    ("ë¹µì´ ì°¨ë¥¼ íƒ€ë©´?", ["ë¹µì¹´", "ë¹µíƒì‹œ", "ë¹µê¸°"], "ë¹µì¹´"),
    ("ì„¸ìƒì—ì„œ ê°€ì¥ ëœ¨ê±°ìš´ ë°”ë‹¤ëŠ”?", ["ì—´ë°›ì•„", "ëœ¨ë°”ë‹¤", "í•«ë°”ë‹¤"], "ì—´ë°›ì•„"),
    ("ìë™ì°¨ê°€ ì›ƒìœ¼ë©´?", ["ì¹´í†¡", "ì›ƒì°¨ì°¨", "ë¶€ë¦‰ë¶€ë¦‰"], "ì¹´í†¡"),
    ("ì™•ì´ ë„˜ì–´ì§€ë©´?", ["í‚¹ì½©", "í‚¹ë°›ë„¤", "í‚¹ì½©í‚¹"], "í‚¹ì½©"),
    ("í™”ì¥ì‹¤ì„ ì˜ì–´ë¡œ í•˜ë©´?", ["íœ´ê²Œì†Œ", "rest room", "ë˜¥ì¹¸"], "rest room"),
    ("ë°”ë‚˜ë‚˜ê°€ ì›ƒìœ¼ë©´?", ["ë°”ë‚˜ë‚˜í‚¥", "ë°”ë‚˜ë‚˜ì›ƒìŒ", "ë°”ë‚˜ë‚˜ë¹µ"], "ë°”ë‚˜ë‚˜í‚¥"),
]

# ------------------------------------------------------------
# ğŸ§© ë¡œì»¬ ë°±ì—… ë¬¸ì œ
# ------------------------------------------------------------
LOCAL_BANK = {
    1: [
        {"type": "quiz", "question": "3+5=?", "options": ["7","8","9"], "answer": "8"},
        {"type": "quiz", "question": "10-4=?", "options": ["5","6","7"], "answer": "6"},
        {"type": "quiz", "question": "2Ã—6=?", "options": ["10","12","14"], "answer": "12"},
    ],
    2: [
        {"type": "quiz", "question": "í•œêµ­ì˜ ìˆ˜ë„ëŠ”?", "options": ["ë¶€ì‚°","ì„œìš¸","ì¸ì²œ"], "answer": "ì„œìš¸"},
        {"type": "quiz", "question": "ë¬¼ì˜ ë“ëŠ”ì ì€?", "options": ["90","100","110"], "answer": "100"},
    ],
    3: [],   # ë ˆë²¨ 3ì€ GPT ìƒì„±ëœ ìœ ëª… ë„Œì„¼ìŠ¤ ì‚¬ìš©
}

# ------------------------------------------------------------
# â­ ë©”ì¸ í€´ì¦ˆ ìƒì„± í•¨ìˆ˜
# ------------------------------------------------------------
def get_quiz_batch(level=1, n=5):
    topic_desc = _topic(level)
    memory_list = load_memory()
    memory_snippet = random_memory_snippet()

    # --------------------------------------------------------
    # ğŸŸ£ ë ˆë²¨ë³„ chat ê°œìˆ˜ ì„¤ì •
    # --------------------------------------------------------
    if level <= 2:
        chat_min = 3
    elif level <= 4:
        chat_min = 2
    else:
        chat_min = 1

    # --------------------------------------------------------
    # ğŸŸ£ memory:true ë¬¸ì œ ì¡°ê±´
    # --------------------------------------------------------
    must_memory = (level >= 5 and len(memory_list) > 0)

    # --------------------------------------------------------
    # ğŸŸ£ í”„ë¡¬í”„íŠ¸ ìƒì„±
    # --------------------------------------------------------
    prompt = f"""
ë„ˆëŠ” 'AI í€´ì¦ˆ + ì¼ìƒëŒ€í™”' ìƒì„±ê¸°ì´ë‹¤.
í•­ìƒ JSON ë°°ì—´([])ë§Œ ì¶œë ¥í•˜ë¼.
ë¬¸ì œëŠ” ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ìƒì„±í•œë‹¤.

í˜„ì¬ ë ˆë²¨: {level}
í˜„ì¬ ë‚œì´ë„ ì„¤ëª…: {topic_desc}

ğŸ¯ ë‚œì´ë„ ê·œì¹™(ë§¤ìš° ì¤‘ìš”):
- ìƒì„±ë˜ëŠ” í€´ì¦ˆëŠ” ë°˜ë“œì‹œ í˜„ì¬ ë ˆë²¨ì˜ ë‚œì´ë„ ë²”ìœ„ ì•ˆì—ì„œë§Œ ë§Œë“¤ì–´ì•¼ í•œë‹¤.
- ë‚œì´ë„ë¥¼ ì ˆëŒ€ ë²—ì–´ë‚˜ì§€ ë§ˆë¼.
- ì•„ë˜ ë§¤í•‘ì„ ì—„ê²©í•˜ê²Œ ë”°ë¼ë¼:

  â€¢ ë ˆë²¨ 1~2 â†’ ì´ˆë“±ìˆ˜ì¤€ ê³„ì‚°Â·ê¸°ì´ˆ ìƒì‹
  â€¢ ë ˆë²¨ 3 â†’ ìœ ëª… í•œêµ­ì–´ ë„Œì„¼ìŠ¤ ë¬¸ì œë§Œ (ì¸í„°ë„·ì—ì„œ í”íˆ ë³¼ ìˆ˜ ìˆëŠ” ìœ í˜•ë§Œ)
  â€¢ ë ˆë²¨ 4 â†’ í•œêµ­ ê¸°ì´ˆ ìƒì‹
  â€¢ ë ˆë²¨ 5 â†’ ì¤‘í•™êµ ìˆ˜ì¤€ ì—­ì‚¬/ê³¼í•™/ì§€ë¦¬
  â€¢ ë ˆë²¨ 6 â†’ ì†ë‹´Â·ë¬¸í™”Â·ìŒì‹ ìƒì‹
  â€¢ ë ˆë²¨ 7 â†’ ê³ ë“±í•™êµ ë¬¸ì œ
  â€¢ ë ˆë²¨ 8 â†’ ì‹¬í™” ìƒì‹Â·ì¶”ë¦¬
  â€¢ ë ˆë²¨ 9 â†’ í•œêµ­ ìœ ë¨¸ ë¬¸ì œ

ğŸ¯ ì¶œë ¥ ê·œì¹™:
- ì´ {n}ê°œ ìƒì„±
- ìµœì†Œ {chat_min}ê°œëŠ” "type": "chat"
- chat ë¬¸ì œëŠ” ì‚¬ìš©ìì˜ ëŒ€ë‹µ ì—†ì´ ê·¸ëƒ¥ ë³´ì—¬ì£¼ëŠ” ëŒ€ì‚¬ë‹¤.

ğŸ¯ ì‚¬ë‹´ ê¸°ë°˜(memory:true) ê·œì¹™:
{"- memory:true ë¬¸ì œëŠ” ë°˜ë“œì‹œ 1ê°œ í¬í•¨í•´ì•¼ í•¨." if must_memory else "- memory:true ë¬¸ì œëŠ” ì ˆëŒ€ ìƒì„±í•˜ì§€ ë§ˆë¼."}

ì‚¬ë‹´ ë°ì´í„°(JSON):
{json.dumps(memory_list, ensure_ascii=False)}

memory:true ë¬¸ì œ í˜•ì‹:
- ì‚¬ë‹´ì´ food â†’ "ë‚´ê°€ ì¢‹ì•„í•œë‹¤ê³  ë§í•œ ìŒì‹ì€?"
- ì‚¬ë‹´ì´ hobby â†’ "ë‚´ê°€ ë¹ ì¡Œë‹¤ê³  í•œ ì·¨ë¯¸ëŠ”?"
- ì‚¬ë‹´ì´ mood â†’ "ë‚´ê°€ ë§í•œ ì˜¤ëŠ˜ ê¸°ë¶„ì€?"

JSON í˜•ì‹:
[
  {{
    "type": "chat" ë˜ëŠ” "quiz",
    "question": "...",
    "options": ["A","B","C"] ë˜ëŠ” [],
    "answer": "ì •ë‹µ ë˜ëŠ” null",
    "memory": true ë˜ëŠ” false
  }}
]
"""

    # --------------------------------------------------------
    # ğŸ§  GPT í˜¸ì¶œ
    # --------------------------------------------------------
    items = []
    try:
        comp = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role":"user","content":prompt}],
            temperature=1.0
        )
        raw = comp.choices[0].message.content
        m = re.search(r"\[.*\]", raw, re.S)

        if m:
            arr = json.loads(m.group())
            for q in arr:
                if isinstance(q, dict) and "type" in q:
                    # options ì—†ëŠ” chat ë¬¸ì œ ì˜ˆë°©
                    if q["type"] == "chat":
                        q["options"] = []
                        q["answer"] = None
                    items.append(q)

    except Exception as e:
        print("âŒ GPT ì˜¤ë¥˜:", e)

    # --------------------------------------------------------
    # ğŸŸ¤ ë ˆë²¨ 3ì€ ìœ ëª… ë„Œì„¼ìŠ¤ 100% ê°•ì œ
    # --------------------------------------------------------
    if level == 3:
        items = []
        selected = random.sample(NONSENSE_BANK, min(n, len(NONSENSE_BANK)))
        for q, opts, ans in selected:
            items.append({
                "type": "quiz",
                "question": q,
                "options": opts,
                "answer": ans,
                "memory": False
            })

    # --------------------------------------------------------
    # ğŸ”§ ë¶€ì¡±í•œ ìˆ˜ ë¡œì»¬ ë¬¸ì œ ë³´ê°•
    # --------------------------------------------------------
    while len(items) < n:
        if level in LOCAL_BANK and LOCAL_BANK[level]:
            items.append(random.choice(LOCAL_BANK[level]))
        else:
            items.append(random.choice(LOCAL_BANK[1]))

    return items
